---
import Container from "./Container.astro";
import ThemeToggle from "./ThemeToggle.astro";
---

<header
  class="fixed top-0 left-0 right-0 z-20 bg-white/25 dark:bg-[#0B1120]/25 backdrop-blur-lg"
  id="mainHeader"
>
  <Container>
    <nav class="flex items-center justify-between h-16 relative w-full">
      <!-- Logo -->
      <a href="/" class="flex items-center gap-3">
        <img
          src="/logo.svg"
          alt="PraxJobs Logo"
          class="h-8 w-8 transform hover:scale-105 transition-transform duration-300 filter dark:invert"
        />
        <span class="font-base text-2xl text-gray-800 dark:text-white"
          >PraxJobs</span
        >
      </a>

      <!-- Right Side Menu Items -->
      <div class="flex items-center gap-4">
        <!-- Mobile Menu Button -->
        <button
          id="mobileMenuButton"
          class="md:hidden p-2 text-gray-800 dark:text-white hover:bg-gray-100 dark:hover:bg-gray-800 rounded-full focus:outline-none focus:ring-2 focus:ring-primary/30"
          aria-label="Open mobile menu"
        >
          <svg
            xmlns="http://www.w3.org/2000/svg"
            class="h-6 w-6"
            fill="none"
            viewBox="0 0 24 24"
            stroke="currentColor"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M4 6h16M4 12h16M4 18h16"></path>
          </svg>
        </button>
        <!-- Desktop Auth/User Menu -->
        <div class="hidden md:flex items-center gap-4">
          <ThemeToggle />

          <!-- Authentication State Container -->
          <div
            id="authStateContainer"
            class="flex items-center gap-4"
            data-authenticated="false"
          >
            <!-- Auth Buttons (Default) -->
            <div id="authButtons" class="flex items-center gap-4">
              <a
                href="/pricing"
                class="px-4 py-2 border-2 border-gray-800 dark:border-gray-100 text-gray-900 dark:text-white hover:bg-gray-100 dark:hover:bg-gray-800 transition-colors duration-300 rounded-full focus:outline-none focus:ring-2 focus:ring-gray-300 focus:ring-offset-2 dark:focus:ring-offset-gray-900"
              >
                Plans
              </a>
              <a
                href="/login"
                class="px-4 py-2 bg-gray-800 text-white hover:bg-black dark:bg-white dark:hover:bg-gray-300 dark:text-black rounded-full transition-colors duration-300"
              >
                Sign In
              </a>
            </div>

            <!-- User Dropdown (Initially Hidden) -->
            <div id="userDropdown" class="hidden relative group">
              <button
                id="userDropdownButton"
                class="flex items-center gap-2 px-4 py-2 text-gray-600 dark:text-gray-300 hover:text-primary dark:hover:text-white transition-colors"
              >
                <span id="userDisplayName">User</span>
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  class="h-4 w-4 transition-transform group-hover:rotate-180"
                  viewBox="0 0 20 20"
                  fill="currentColor"
                >
                  <path
                    fill-rule="evenodd"
                    d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z"
                    clip-rule="evenodd"></path>
                </svg>
              </button>

              <div
                id="userDropdownMenu"
                class="absolute right-0 top-full mt-2 w-48 bg-white dark:bg-gray-900 rounded-lg shadow-lg py-1 invisible opacity-0 scale-95 transition-all duration-300 ease-in-out origin-top-right z-50 border border-gray-200 dark:border-gray-700 group-hover:visible group-hover:opacity-100 group-hover:scale-100"
              >
                <a
                  href="/settings"
                  class="block px-4 py-2 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700"
                >
                  Settings
                </a>
                <a
                  href="/dashboard"
                  class="block px-4 py-2 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700"
                >
                  Dashboard
                </a>
                <a
                  href="/pricing"
                  class="block px-4 py-2 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700"
                >
                  Pricing
                </a>
                <button
                  id="signOutButton"
                  class="w-full text-left px-4 py-2 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700"
                >
                  Sign Out
                </button>
              </div>
            </div>
            <!-- Tools Dropdown -->
            <div class="relative group">
              <button
                id="toolsDropdownButton"
                class="flex items-center gap-2 px-4 py-2 text-gray-600 dark:text-gray-300 hover:text-primary dark:hover:text-white transition-colors"
              >
                Tools
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  class="h-4 w-4 transition-transform group-hover:rotate-180"
                  viewBox="0 0 20 20"
                  fill="currentColor"
                >
                  <path
                    fill-rule="evenodd"
                    d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z"
                    clip-rule="evenodd"></path>
                </svg>
              </button>
              <div
                id="toolsDropdownMenu"
                class="absolute left-0 top-full mt-2 w-48 bg-white dark:bg-gray-900 rounded-lg shadow-lg py-1 invisible opacity-0 scale-95 transition-all duration-300 ease-in-out origin-top-left z-50 border border-gray-200 dark:border-gray-700 group-hover:visible group-hover:opacity-100 group-hover:scale-100"
              >
                <a
                  href="javascript:void(0)"
                  data-tool-href="/job-analysis"
                  class="block px-4 py-2 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700"
                >
                  Job Analysis
                </a>
                <a
                  href="javascript:void(0)"
                  data-tool-href="/resume"
                  class="block px-4 py-2 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700"
                >
                  Resume Tailoring
                </a>
                <a
                  href="javascript:void(0)"
                  data-tool-href="/cover-letter"
                  class="block px-4 py-2 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700"
                >
                  Cover Letter Generator
                </a>
                <a
                  href="javascript:void(0)"
                  data-tool-href="/job-tracker"
                  class="block px-4 py-2 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700"
                >
                  Job Tracker
                </a>
                <a
                  href="javascript:void(0)"
                  data-tool-href="/interview-prep"
                  class="block px-4 py-2 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700"
                >
                  Interview Preparation
                </a>
              </div>
            </div>
          </div>
        </div>
      </div>
    </nav>
  </Container>
</header>

<!-- Mobile Menu (Rendered in a slot outside main content) -->
<div slot="mobile-menu">
  <div
    id="mobile-menu-overlay"
    class="fixed inset-0 bg-black/50 backdrop-blur-sm z-[60] opacity-0 invisible transition-all duration-300 ease-in-out"
    aria-hidden="true"
  >
  </div>

  <div
    id="mobile-menu-panel"
    class="fixed inset-y-0 right-0 w-full max-w-md bg-white dark:bg-gray-900/90 shadow-2xl transform translate-x-full transition-transform duration-300 ease-in-out overflow-y-auto z-[70]"
    role="dialog"
    aria-modal="true"
    aria-labelledby="mobile-menu-title"
  >
    <!-- Close Button -->
    <div
      class="sticky top-0 z-20 bg-white/80 dark:bg-gray-900/80 backdrop-blur-sm"
    >
      <button
        id="mobile-menu-close-btn"
        class="absolute top-4 bg-black text-white dark:text-black dark:bg-white right-4 p-2 rounded-full hover:bg-gray-100 dark:hover:bg-gray-800 focus:outline-none focus:ring-2 focus:ring-primary/50 transition-colors"
        aria-label="Close mobile menu"
      >
        <svg
          xmlns="http://www.w3.org/2000/svg"
          class="h-6 w-6"
          fill="none"
          viewBox="0 0 24 24"
          stroke="currentColor"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M6 18L18 6M6 6l12 12"></path>
        </svg>
      </button>
    </div>

    <!-- Menu Content -->
    <div class="px-6 py-8 space-y-8">
      <!-- User Profile Section -->
      <div id="mobile-user-section" class="space-y-4">
        <!-- Authenticated User View -->
        <div
          id="mobile-user-authenticated"
          class="hidden flex items-center space-x-4 bg-gray-100 dark:bg-gray-800 p-4 rounded-xl"
        >
          <div
            class="w-12 h-12 rounded-full bg-primary/10 flex items-center justify-center"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              class="h-8 w-8 text-primary"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"
              ></path>
            </svg>
          </div>
          <div>
            <p
              id="mobile-user-name"
              class="text-lg font-semibold text-gray-900 dark:text-white"
            >
              User Name
            </p>
            <p
              id="mobile-user-email"
              class="text-sm text-gray-500 dark:text-gray-400"
            >
              user@example.com
            </p>
          </div>
        </div>

        <!-- Navigation Links -->
        <nav class="space-y-2" aria-label="Mobile Navigation">
          <a
            href="/dashboard"
            class="mobile-nav-link group flex items-center space-x-3 px-4 py-3 rounded-xl hover:bg-gray-100 dark:hover:bg-gray-800 transition-colors"
            data-requires-auth="true"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              class="h-6 w-6"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
            >
              <path
                class="text-gray-900 dark:text-white"
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h8l4 4v10a2 2 0 01-2 2z"
              ></path>
            </svg>
            <span
              class="text-gray-800 dark:text-gray-200 group-hover:text-primary transition-colors"
            >
              Dashboard
            </span>
          </a>
          <a
            href="/settings"
            class="mobile-nav-link group flex items-center space-x-3 px-4 py-3 rounded-xl hover:bg-gray-100 dark:hover:bg-gray-800 transition-colors"
            data-requires-auth="true"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              class="h-6 w-6"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
            >
              <path
                class="text-gray-900 dark:text-white"
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c-.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"
              ></path>
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
            </svg>
            <span
              class="text-gray-800 dark:text-gray-200 group-hover:text-primary transition-colors"
            >
              Settings
            </span>
          </a>
          <a
            href="/pricing"
            class="mobile-nav-link group flex items-center space-x-3 px-4 py-3 rounded-xl hover:bg-gray-100 dark:hover:bg-gray-800 transition-colors"
            data-requires-auth="false"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              class="h-6 w-6"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
            >
              <path
                class="text-gray-900 dark:text-white"
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z"
              ></path>
            </svg>
            <span
              class="text-gray-800 dark:text-gray-200 group-hover:text-primary"
            >
              Plans
            </span>
          </a>
        </nav>

        <!-- Tools Section -->
        <div class="space-y-2">
          <h3 class="text-sm font-medium text-gray-500 dark:text-gray-400 px-4">
            Tools
          </h3>
          <nav class="space-y-2">
            <a
              href="javascript:void(0)"
              data-tool-href="/job-analysis"
              class="mobile-nav-link text-gray-950 dark:text-white group flex items-center space-x-3 px-4 py-3 rounded-xl hover:bg-gray-100 dark:hover:bg-gray-800 transition-colors"
              data-requires-auth="false"
            >
              <svg
                xmlns="http://www.w3.org/2000/svg"
                class="h-5 w-5 text-primary"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h14a2 2 0 002-2v-5a2 2 0 00-2-2m-1-1h-6m-1 1v6a2 2 0 002 2h2a2 2 0 002-2V7m-3 1h-1"
                ></path>
              </svg>
              <span>Job Analysis</span>
            </a>
            <a
              href="javascript:void(0)"
              data-tool-href="/resume"
              class="mobile-nav-link text-gray-950 dark:text-white group flex items-center space-x-3 px-4 py-3 rounded-xl hover:bg-gray-100 dark:hover:bg-gray-800 transition-colors"
              data-requires-auth="false"
            >
              <svg
                xmlns="http://www.w3.org/2000/svg"
                class="h-5 w-5 text-primary"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"
                ></path>
              </svg>
              <span>Resume Tailoring</span>
            </a>
            <a
              href="javascript:void(0)"
              data-tool-href="/cover-letter"
              class="mobile-nav-link text-gray-950 dark:text-white group flex items-center space-x-3 px-4 py-3 rounded-xl hover:bg-gray-100 dark:hover:bg-gray-800 transition-colors"
              data-requires-auth="false"
            >
              <svg
                xmlns="http://www.w3.org/2000/svg"
                class="h-5 w-5 text-primary"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"
                ></path>
              </svg>
              <span>Cover Letter Generator</span>
            </a>
            <a
              href="javascript:void(0)"
              data-tool-href="/job-tracker"
              class="mobile-nav-link text-gray-950 dark:text-white group flex items-center space-x-3 px-4 py-3 rounded-xl hover:bg-gray-100 dark:hover:bg-gray-800 transition-colors"
              data-requires-auth="false"
            >
              <svg
                xmlns="http://www.w3.org/2000/svg"
                class="h-5 w-5 text-primary"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M21 13.255A23.931 23.931 0 0112 15c-3.183 0-6.22-.62-9-1.745M16 6V4a2 2 0 00-2-2h-4a2 2 0 00-2 2v2m4 6h.01M5 20h14a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"
                ></path>
              </svg>
              <span>Job Tracker</span>
            </a>
            <a
              href="javascript:void(0)"
              data-tool-href="/interview-prep"
              class="mobile-nav-link text-gray-950 dark:text-white group flex items-center space-x-3 px-4 py-3 rounded-xl hover:bg-gray-100 dark:hover:bg-gray-800 transition-colors"
              data-requires-auth="false"
            >
              <svg
                xmlns="http://www.w3.org/2000/svg"
                class="h-5 w-5 text-primary"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h14a2 2 0 002-2v-5a2 2 0 00-2-2m-1-1h-6m-1 1v6a2 2 0 002 2h2a2 2 0 002-2V7m-3 1h-1"
                ></path>
              </svg>
              <span>Interview Preparation</span>
            </a>
          </nav>
        </div>

        <!-- Theme Toggle -->
        <div class="space-y-4">
          <h3 class="text-sm font-medium text-gray-500 dark:text-gray-400 px-4">
            Appearance
          </h3>
          <div class="grid grid-cols-2 gap-4">
            <button
              id="light-theme"
              class="theme-toggle-btn w-full btn btn-outline flex items-center justify-center space-x-2"
            >
              <svg
                xmlns="http://www.w3.org/2000/svg"
                class="h-5 w-5 text-gray-950 dark:text-white"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M12 3v1m0 16v1m9-9h-1M4 12H3m3.343-5.657L5.929 5.929m12.728 12.728L18.071 18.07M12 7a5 5 0 110 10 5 5 0 010-10z"
                ></path>
              </svg>
              <span class="text-gray-950 dark:text-white">Light</span>
            </button>
            <button
              id="dark-theme"
              class="theme-toggle-btn w-full btn btn-outline flex items-center justify-center space-x-2"
            >
              <svg
                xmlns="http://www.w3.org/2000/svg"
                class="h-5 w-5 text-gray-950 dark:text-white"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"
                ></path>
              </svg>
              <span class="text-gray-950 dark:text-white">Dark</span>
            </button>
          </div>
        </div>

        <!-- Login/Signup Buttons -->
        <div id="mobile-user-unauthenticated" class="space-y-6">
          <a
            href="/login"
            class="mt-10 w-full btn bg-gray-900 text-white dark:bg-white/90 dark:text-gray-950 p-4 rounded-xl flex items-center justify-center space-x-2"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              class="h-5 w-5"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
            >
              <path
                class="text-white dark:text-gray-950"
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M11 16l-4-4m0 0l4-4m-4 4h14m-5 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h7a3 3 0 013 3v1"
              ></path>
            </svg>
            <span class="text-white dark:text-gray-950">Sign In</span>
          </a>
        </div>

        <!-- Sign Out Button -->
        <div>
          <button
            id="mobile-signout-btn"
            class="mt-10 w-full btn bg-gray-900 text-white dark:bg-white/90 dark:text-gray-950 p-4 rounded-xl flex items-center justify-center space-x-2 hi"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              class="h-5 w-5 text-gray-950 dark:text-white"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
            >
              <path
                class="text-white dark:text-gray-950"
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M17 16l4-4m0 0l-4-4m4 4H7a2 2 0 01-2-2V5a2 2 0 012-2h14a2 2 0 012 2v10a2 2 0 01-2 2z"
              ></path>
            </svg>
            <span class="text-white dark:text-gray-950">Sign Out</span>
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  import { signOut } from "firebase/auth";
  import { firebaseInstance } from "../lib/firebase";
  import { authStore, isAuthenticated, getCurrentUser } from "../lib/authStore";

  // Centralized DOM element selection
  const elements = {
    // Desktop elements
    authStateContainer: document.getElementById("authStateContainer"),
    authButtons: document.getElementById("authButtons"),
    userDropdown: document.getElementById("userDropdown"),
    userDisplayName: document.getElementById("userDisplayName"),
    userDropdownButton: document.getElementById("userDropdownButton"),
    userDropdownMenu: document.getElementById("userDropdownMenu"),
    signOutButton: document.getElementById("signOutButton"),
    toolsDropdownButton: document.getElementById("toolsDropdownButton"),
    toolsDropdownMenu: document.getElementById("toolsDropdownMenu"),

    // Mobile elements
    mobileMenuButton: document.getElementById("mobileMenuButton"),
    mobileMenuOverlay: document.getElementById("mobile-menu-overlay"),
    mobileMenuPanel: document.getElementById("mobile-menu-panel"),
    mobileMenuCloseBtn: document.getElementById("mobile-menu-close-btn"),
    mobileUserAuthenticated: document.getElementById(
      "mobile-user-authenticated"
    ),
    mobileUserUnauthenticated: document.getElementById(
      "mobile-user-unauthenticated"
    ),
    mobileUserName: document.getElementById("mobile-user-name"),
    mobileUserEmail: document.getElementById("mobile-user-email"),
    mobileNavLinks: document.querySelectorAll(".mobile-nav-link"),
    mobileSignOutBtn: document.getElementById("mobile-signout-btn"),

    // Theme toggle
    themeToggleBtns: document.querySelectorAll(".theme-toggle-btn"),
  };

  // Unified Authentication UI Management
  async function manageAuthUI() {
    try {
      const authenticated = await isAuthenticated();
      const user = await getCurrentUser();

      // Update desktop UI
      if (elements.authStateContainer) {
        elements.authStateContainer.setAttribute(
          "data-authenticated",
          authenticated ? "true" : "false"
        );
      }

      if (elements.authButtons) {
        elements.authButtons.classList.toggle("hidden", authenticated);
      }

      if (elements.userDropdown) {
        elements.userDropdown.classList.toggle("hidden", !authenticated);
      }

      // Update mobile UI
      if (
        elements.mobileUserAuthenticated &&
        elements.mobileUserUnauthenticated
      ) {
        elements.mobileUserAuthenticated.classList.toggle(
          "hidden",
          !authenticated
        );
        elements.mobileUserUnauthenticated.classList.toggle(
          "hidden",
          authenticated
        );
      }

      // Toggle mobile sign out button visibility
      if (elements.mobileSignOutBtn) {
        elements.mobileSignOutBtn.classList.toggle("hidden", !authenticated);
      }

      // Set display name
      if (user) {
        const displayName =
          user.displayName || user.email?.split("@")[0] || "User";

        if (elements.userDisplayName) {
          elements.userDisplayName.textContent = displayName;
        }

        if (elements.mobileUserName) {
          elements.mobileUserName.textContent = displayName;
        }

        if (elements.mobileUserEmail && user.email) {
          elements.mobileUserEmail.textContent = user.email;
        }
      }

      // Manage navigation links visibility
      elements.mobileNavLinks?.forEach((link) => {
        const requiresAuth = link.getAttribute("data-requires-auth") === "true";
        link.classList.toggle("hidden", requiresAuth && !authenticated);
      });
    } catch (error) {
      console.error("Authentication UI Management Error", error);
    }
  }

  // Dropdown Toggle
  function setupDropdownToggle() {
    if (!elements.userDropdownButton || !elements.userDropdownMenu) return;

    function toggleDropdown(event: Event) {
      event.stopPropagation();
      elements.userDropdownMenu?.classList.toggle("invisible");
      elements.userDropdownMenu?.classList.toggle("opacity-0");
      elements.userDropdownMenu?.classList.toggle("scale-95");
    }

    function handleOutsideClick(event: Event) {
      if (
        elements.userDropdownMenu &&
        !elements.userDropdownMenu.classList.contains("invisible")
      ) {
        const isClickInside =
          elements.userDropdownButton?.contains(event.target as Node) ||
          elements.userDropdownMenu.contains(event.target as Node);

        if (!isClickInside) {
          elements.userDropdownMenu.classList.add(
            "invisible",
            "opacity-0",
            "scale-95"
          );
        }
      }
    }

    elements.userDropdownButton.addEventListener("click", toggleDropdown);
    document.addEventListener("click", handleOutsideClick);
  }

  // Tools Dropdown Functionality
  function setupToolsDropdown() {
    if (!elements.toolsDropdownButton || !elements.toolsDropdownMenu) return;

    // Desktop Tools Dropdown
    elements.toolsDropdownButton.addEventListener("click", (e) => {
      e.stopPropagation();
      elements.toolsDropdownMenu?.classList.toggle("opacity-0");
      elements.toolsDropdownMenu?.classList.toggle("invisible");
    });

    // Close dropdown when clicking outside
    document.addEventListener("click", () => {
      if (elements.toolsDropdownMenu) {
        elements.toolsDropdownMenu.classList.add("opacity-0");
        elements.toolsDropdownMenu.classList.add("invisible");
      }
    });
  }

  // Mobile Menu Functionality
  function setupMobileMenu() {
    if (
      !elements.mobileMenuButton ||
      !elements.mobileMenuOverlay ||
      !elements.mobileMenuPanel
    )
      return;

    function openMobileMenu() {
      elements.mobileMenuOverlay?.classList.remove("invisible", "opacity-0");
      elements.mobileMenuPanel?.classList.remove("translate-x-full");
      document.body.classList.add("overflow-hidden");
    }

    function closeMobileMenu() {
      elements.mobileMenuOverlay?.classList.add("opacity-0", "invisible");
      elements.mobileMenuPanel?.classList.add("translate-x-full");
      document.body.classList.remove("overflow-hidden");
    }

    // Open mobile menu
    elements.mobileMenuButton.addEventListener("click", openMobileMenu);

    // Close mobile menu
    elements.mobileMenuCloseBtn?.addEventListener("click", closeMobileMenu);

    // Close on overlay click
    elements.mobileMenuOverlay.addEventListener("click", (e) => {
      if (e.target === elements.mobileMenuOverlay) {
        closeMobileMenu();
      }
    });

    // Close on Escape key
    document.addEventListener("keydown", (e) => {
      if (
        e.key === "Escape" &&
        !elements.mobileMenuPanel?.classList.contains("translate-x-full")
      ) {
        closeMobileMenu();
      }
    });
  }

  // Theme Toggle Functionality
  function setupThemeToggle() {
    elements.themeToggleBtns.forEach((btn) => {
      btn.addEventListener("click", () => {
        const theme = btn.id === "light-theme" ? "light" : "dark";
        document.documentElement.classList.toggle("dark", theme === "dark");
        localStorage.setItem("color-theme", theme);
      });
    });

    // Initial theme setup
    const savedTheme = localStorage.getItem("color-theme") || "light";
    document.documentElement.classList.toggle("dark", savedTheme === "dark");
  }

  // Sign Out Handler
  async function handleSignOut() {
    try {
      const auth = firebaseInstance?.auth;
      if (auth) {
        await signOut(auth);
        authStore.set({
          user: null,
          loading: false,
          lastActivity: null,
        });
        localStorage.removeItem("astro_resume_user_data");
        window.location.href = "/login";
      }
    } catch (error) {
      console.error("Sign out failed", error);
    }
  }

  // Initialize everything
  function initializeHeader() {
    manageAuthUI();
    setupDropdownToggle();
    setupToolsDropdown();
    setupMobileMenu();
    setupThemeToggle();

    // Attach sign out handlers
    elements.signOutButton?.addEventListener("click", handleSignOut);
    elements.mobileSignOutBtn?.addEventListener("click", handleSignOut);
  }

  // Handle tool link clicks and authentication check
  function setupToolLinks() {
    // Find all tool links in header
    const toolLinks = document.querySelectorAll("[data-tool-href]");

    toolLinks.forEach((link) => {
      link.addEventListener("click", async (e) => {
        e.preventDefault();

        // Get the target URL
        const targetUrl = link.getAttribute("data-tool-href");

        // Skip if no target URL is found
        if (!targetUrl) return;

        // Check authentication
        const authenticated = await isAuthenticated();

        if (authenticated) {
          // User is authenticated, navigate directly to the tool
          window.location.href = targetUrl;
        } else {
          // User is not authenticated, redirect to login with return URL
          const encodedRedirect = encodeURIComponent(targetUrl);
          window.location.href = `/login?redirect=${encodedRedirect}`;
        }
      });
    });
  }

  // Run initialization
  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", () => {
      initializeHeader();
      setupToolLinks();
    });
  } else {
    initializeHeader();
    setupToolLinks();
  }

  // Listen for auth store changes
  authStore.subscribe(manageAuthUI);
</script>

<style>
  .mobile-nav-link.hidden {
    display: none;
  }
</style>
